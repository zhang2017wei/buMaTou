{"version":3,"file":"index.js","sources":["../src/loader-meta.ts","../src/webpack.mini.ts","../src/webpack.h5.ts","../src/index.ts"],"sourcesContent":["import * as acorn from 'acorn'\nimport * as walk from 'acorn-walk'\nimport { Frameworks } from './index'\n\ninterface ILoaderMeta {\n  importFrameworkStatement: string\n  mockAppStatement: string\n  frameworkArgs: string\n  creator: string\n  creatorLocation: string\n  importFrameworkName: string\n  isNeedRawLoader?: boolean\n  extraImportForWeb?: string\n  execBeforeCreateWebApp?: string\n  compatComponentImport?: string\n  compatComponentExtra?: string\n  modifyConfig?: (config: Record<string, any>, source: string) => void\n}\n\nfunction addConfig (source) {\n  const configsMap = {\n    enableShareAppMessage: ['onShareAppMessage', 'useShareAppMessage'],\n    enableShareTimeline: ['onShareTimeline', 'useShareTimeline']\n  }\n  const ast = acorn.parse(source, {\n    ecmaVersion: 'latest',\n    sourceType: 'module'\n  })\n\n  const additionConfig: Record<string, any> = {}\n\n  function check (name: string) {\n    Object.keys(configsMap).forEach(configName => {\n      const apis: string[] = configsMap[configName]\n      if (apis.includes(name)) {\n        additionConfig[configName] = true\n      }\n    })\n  }\n\n  walk.simple(ast, {\n    FunctionExpression (node: any) {\n      if (!node.id || !node.id.name) return\n      check(node.id.name)\n    },\n    FunctionDeclaration (node: any) {\n      if (!node.id || !node.id.name) return\n      check(node.id.name)\n    },\n    CallExpression (node: any) {\n      const { callee } = node\n      if (callee.type === 'Identifier') {\n        check(callee.name)\n      } else if (callee.type === 'MemberExpression') {\n        if (callee.property.type === 'Identifier') {\n          check(callee.property.name)\n        } else if (callee.property.type === 'Literal') {\n          check(callee.property.value)\n        }\n      }\n    }\n  })\n\n  return additionConfig\n}\n\nconst frameworkMeta: Record<string, ILoaderMeta> = {\n  nerv: {\n    importFrameworkStatement: `\nimport Nerv from 'nervjs';\n`,\n    mockAppStatement: `\nclass App extends Nerv.Component {\n  render () {\n    return this.props.children\n  }\n}\n`,\n    frameworkArgs: 'Nerv, Nerv, config',\n    creator: 'createReactApp',\n    creatorLocation: '@tarojs/plugin-framework-react/dist/runtime',\n    importFrameworkName: 'Nerv',\n    modifyConfig (config, source) {\n      Object.assign(config, addConfig(source))\n    }\n  },\n  react: {\n    importFrameworkStatement: `\nimport * as React from 'react'\nimport ReactDOM from 'react-dom'\n`,\n    mockAppStatement: `\nclass App extends React.Component {\n  render () {\n    return this.props.children\n  }\n}\n`,\n    frameworkArgs: 'React, ReactDOM, config',\n    creator: 'createReactApp',\n    creatorLocation: '@tarojs/plugin-framework-react/dist/runtime',\n    importFrameworkName: 'React',\n    compatComponentImport: 'import { PullDownRefresh } from \"@tarojs/components\"',\n    compatComponentExtra: 'config.PullDownRefresh = PullDownRefresh',\n    modifyConfig (config, source) {\n      Object.assign(config, addConfig(source))\n    }\n  }\n}\n\nexport function getLoaderMeta (framework: Frameworks) {\n  if (framework === 'preact') framework = 'react'\n  return frameworkMeta[framework]\n}\n","\nimport { getLoaderMeta } from './loader-meta'\n\nimport type { IPluginContext } from '@tarojs/service'\nimport type { Frameworks } from './index'\n\nexport function modifyMiniWebpackChain (ctx: IPluginContext, framework: Frameworks, chain) {\n  setAlias(ctx, framework, chain)\n  setLoader(framework, chain)\n}\n\nfunction setAlias (ctx: IPluginContext, framework: Frameworks, chain) {\n  const config = ctx.initialConfig\n  const alias = chain.resolve.alias\n\n  if (framework === 'react') {\n    alias.set('react-dom$', '@tarojs/react')\n    if (process.env.NODE_ENV !== 'production' && config.mini?.debugReact !== true) {\n      // 不是生产环境，且没有设置 debugReact，则使用压缩版本的 react 依赖，减少体积\n      alias.set('react-reconciler$', 'react-reconciler/cjs/react-reconciler.production.min.js')\n      alias.set('react$', 'react/cjs/react.production.min.js')\n      alias.set('scheduler$', 'scheduler/cjs/scheduler.production.min.js')\n      alias.set('react/jsx-runtime$', 'react/cjs/react-jsx-runtime.production.min.js')\n    }\n  }\n}\n\nfunction setLoader (framework: Frameworks, chain) {\n  chain.plugin('miniPlugin')\n    .tap(args => {\n      args[0].loaderMeta = getLoaderMeta(framework)\n      return args\n    })\n}\n","\nimport { getLoaderMeta } from './loader-meta'\n\nimport type { IPluginContext } from '@tarojs/service'\nimport type { Frameworks } from './index'\n\nexport function modifyH5WebpackChain (ctx: IPluginContext, framework: Frameworks, chain) {\n  setAlias(ctx, chain)\n  setLoader(framework, chain)\n  setPlugin(ctx, framework, chain)\n\n  chain.merge({\n    module: {\n      rule: {\n        'process-import-taro': {\n          test: /taro-h5[\\\\/]dist[\\\\/]index/,\n          loader: require.resolve('./api-loader')\n        }\n      }\n    }\n  })\n}\n\nfunction setAlias (ctx: IPluginContext, chain) {\n  const config = ctx.initialConfig\n  const alias = chain.resolve.alias\n\n  if (config.h5?.useHtmlComponents) {\n    alias.set('@tarojs/components$', '@tarojs/components-react/index')\n  } else {\n    alias.set('@tarojs/components$', '@tarojs/components/dist-h5/react')\n  }\n}\n\nfunction setLoader (framework: Frameworks, chain) {\n  chain.plugin('mainPlugin')\n    .tap(args => {\n      args[0].loaderMeta = getLoaderMeta(framework)\n      return args\n    })\n}\n\nfunction setPlugin (ctx: IPluginContext, framework: Frameworks, chain) {\n  const config = ctx.initialConfig\n\n  if (\n    process.env.NODE_ENV !== 'production' &&\n    config.h5?.devServer?.hot !== false\n  ) {\n    // 默认开启 fast-refresh\n    if (framework === 'react') {\n      chain\n        .plugin('fastRefreshPlugin')\n        .use(require('@pmmmwh/react-refresh-webpack-plugin'))\n    } else if (framework === 'preact') {\n      chain\n        .plugin('fastRefreshPlugin')\n        .use(require('@prefresh/webpack'))\n    }\n  }\n}\n","import { modifyMiniWebpackChain } from './webpack.mini'\nimport { modifyH5WebpackChain } from './webpack.h5'\n\nimport type { IPluginContext } from '@tarojs/service'\n\nexport type Frameworks = 'react' | 'preact' | 'nerv'\n\nexport default (ctx: IPluginContext) => {\n  const { framework } = ctx.initialConfig\n\n  if (framework !== 'react' && framework !== 'nerv' && framework !== 'preact') return\n\n  ctx.modifyWebpackChain(({ chain }) => {\n    // 通用\n    setAlias(framework, chain)\n    chain\n      .plugin('definePlugin')\n      .tap(args => {\n        const config = args[0]\n        config.__TARO_FRAMEWORK__ = `\"${framework}\"`\n        return args\n      })\n\n    if (process.env.TARO_ENV === 'h5') {\n      // H5\n      modifyH5WebpackChain(ctx, framework, chain)\n    } else {\n      // 小程序\n      modifyMiniWebpackChain(ctx, framework, chain)\n    }\n  })\n}\n\nfunction setAlias (framework: Frameworks, chain) {\n  const alias = chain.resolve.alias\n\n  switch (framework) {\n    case 'preact':\n      alias.set('react', 'preact/compat')\n      alias.set('react-dom/test-utils', 'preact/test-utils')\n      alias.set('react-dom', 'preact/compat')\n      alias.set('react/jsx-runtime', 'preact/jsx-runtime')\n      break\n    case 'nerv':\n      alias.set('react$', 'nervjs')\n      alias.set('react-dom$', 'nervjs')\n      break\n  }\n}\n"],"names":["acorn","walk","setAlias","setLoader"],"mappings":"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"}